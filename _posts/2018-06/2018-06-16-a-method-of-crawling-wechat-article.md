---
layout: post
title: 微信文章爬虫思路
categories: Tech
tags: 爬虫
---

* content
{:toc}


### 一、问题

大家知道，现如今微信在中国人民的生活中占着举足轻重的位置，上到爷爷奶奶，下到小学生，都能熟练打开微信聊天、浏览转发文章，也正是因为微信的普及性，微信文章的内容分析成了很多公司制定营销策略重要参考。不过，如今微信文章的反爬策略做得越来越高明，让很多企业束手无策，只好购买第三方的数据。本文将介绍一种基于微信pc客户端的方法，爬取微信文章内容、阅读量、点赞量。

通常我们会选择搜狗搜索引擎来爬取微信文章，只不过这种方法存在一些问题：

- 未登录的状态下只能浏览10页
- 搜狗里的文章只有文章内容、没有点赞量、阅读量和评论呢
- 搜狗里的url具有时效性，过了一段时间变为不可访问






### 二、方案

方案中涉及的编程语言均为python3，所以需要在电脑上事先安装python3环境。

#### 思路

首先登录问题，我们可以通过selenium + chromedriver 来模拟浏览器扫码登录；而对于剩下的两点，经过研究测试，我们发现：

**将来自搜狗的url作为信息通过微信pc端向一个朋友发送后，鼠标点击该链接得到的url是永久有效的，同时也能获得浏览量、点赞量和回复等信息**

由此我们可以这样设计爬虫：

1. 通过搜狗获取微信文章url
2. 通过微信pc端向一个朋友(或文件传输助手)发送从搜狗里收集到的url，并点击浏览
3. 获取微信pc端浏览的url，爬取相应数据




#### 设计

这个思路是正确的，但在实施的时候我们还需要解决一些障碍，下面我来说说最终方案：

![流程图](/posts_pic/2018-06/2018-06-16-a-method-of-crawling-wechat-article/liucheng.png)



- pc1需为ｗindows(因为微信pc端目前只支持ｗindows)。将url自动输入微信聊天界面并点击浏览，我这边采用python的pywinauto包。这个包的功能类似按键精灵，可以模拟鼠标键盘事件，使用过程中注意版本，如果出现pywinauto无法控制鼠标和键盘，可以试着降低pywinauto的版本。pywinauto的鼠标和键盘输入位置是通过像素点位置定位的（通过打开qq截图，移动鼠标时鼠标箭头旁边变化的那两个值），所以在程序中设置好了像素点位置后就不要再移动微信聊天窗口的位置了。
- pc2为linux，我们会在这台机器安装**[ｍitmproxy](https://mitmproxy.org)**。mitmproxy是一个支持HTTP和HTTPS的抓包程序，有类似Fiddler、Charles的功能。我们要用到它的一个功能是带python脚本启动，该脚本处理ｍitmproxy拦截到的response，我们要解析得到微信文章相关数据的代码就写在这里。在pc2上启动ｍitmproxy后，需要在pc1上设置代理为pc2的ip和端口，设置好代理后浏览器打开mitm.it这个网页下载安装证书。([mitmproxy文档](http://docs.mitmproxy.org/en/v0.18.2/introduction.html))

整个运行流程是：
1. pc2上带脚本参数启动ｍitmproxy(脚本事先写好)
2. pc1上启动微信客户端，打开一个聊天框，摆放好位置后用截图工具定位输入框位置和消息链接的位置（可以先手动发送几条url，再定位）
3. 把定位参数设置到读取并发送搜狗url的脚本里后，启动该脚本。




### 三、代码

ｇithub: [微信爬虫](https://github.com/Brook-Lan/wechat)









